var MYBB_SMILIES={},smileyMapdes2=dropdownsmiliesdes.concat(dropdownsmiliesdesmore),isWebkit="WebkitAppearance"in document.documentElement.style,i;for(i in smileyMapurl)MYBB_SMILIES[smileyMapurl[i]]=smileyMapdes2[i];
$(document).ready(function(){if($("#quick_reply_form").length)$(document).on("mouseup touchend",function(){var a=$(event.target),b=!0,e="";a.hasClass("post")||(a=a.parents(".post"));if(a&&a.length&&(e=a[0].id.split("_")[1],0==$("#pid_"+e+"").has("form").length)){var c=window.getSelection();if(0<c.rangeCount){var h=c.getRangeAt(0);$.trim(window.getSelection().toString())&&beforeselect!=h&&(beforeselect=h,elementContainsSelection(a.find(".post_body")[0])&&(range=c.getRangeAt(0),rect=range.getBoundingClientRect(),
$elm=$("#qr_pid_"+e+"").show(),$elm.css({top:window.scrollY+rect.top+rect.height+6+"px",left:getposition().left-$elm.outerWidth()+10+"px"}),b=!1))}}b&&$("#qr_pid_"+e+"").hide()})});function isOrContains(a,b){for(;a;){if(a===b)return!0;a=a.parentNode}return!1}
function elementContainsSelection(a){var b;if(window.getSelection){if(b=window.getSelection(),0<b.rangeCount){for(var e=0;e<b.rangeCount;++e)if(!isOrContains(b.getRangeAt(e).commonAncestorContainer,a))return!1;return!0}}else if((b=document.selection)&&"Control"!=b.type)return isOrContains(b.createRange().parentElement(),a);return!1}
function getposition(){var a,b="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2),e={},c;document.selection&&document.selection.createRange?(c=document.selection.createRange().duplicate(),c.collapse(!1),c.pasteHTML('\x3cspan id\x3d"'+b+'" style\x3d"position: relative;"\x3e\x26#xfeff;\x3c/span\x3e'),a=document.getElementById(b)):window.getSelection&&(a=window.getSelection(),a.getRangeAt?c=a.getRangeAt(0).cloneRange():(c=document.createRange(),c.setStart(a.anchorNode,a.anchorOffset),
c.setEnd(a.focusNode,a.focusOffset),c.collapsed!==a.isCollapsed&&(c.setStart(a.focusNode,a.focusOffset),c.setEnd(a.anchorNode,a.anchorOffset))),c.collapse(!1),a=document.createElement("span"),a.id=b,a.appendChild(document.createTextNode("﻿")),c.insertNode(a));if(a){var b=a,h=c=0;do c+=b.offsetLeft,h+=b.offsetTop;while(b=b.offsetParent);e.left=c;e.top=h;a.parentNode.removeChild(a);return e}}var beforeselect=null;
function quick_quote(a,b,e){$("#quick_reply_form").length&&($('body:not("#pid_'+a+'")').click(function(b){$.trim(window.getSelection().toString())||$("#qr_pid_"+a+"").hide()}),$("#qr_pid_"+a+"").click(function(c){c.preventDefault();setTimeout(function(){if(elementContainsSelection(document.getElementById("pid_"+a+""))){Thread.quickQuote(a,""+b+"",e);$("#qr_pid_"+a+"").hide();var c=window.getSelection?window.getSelection():document.selection;c&&(c.removeAllRanges?c.removeAllRanges():c.empty&&c.empty())}else $("#qr_pid_"+
a+"").hide()},200)}))}Thread.quickQuote=function(a,b,e){if(isWebkit||window.getSelection().toString().trim()){var c=window.getSelection(),h=c.getRangeAt(0).cloneContents();a=parseInt(rinvbquote)?"[quote\x3d"+b+";"+a+"]\n":"[quote\x3d'"+b+"' pid\x3d'"+a+"' dateline\x3d'"+e+"']\n";for(c=c.getRangeAt(0).commonAncestorContainer;"undefined"==typeof c.tagName;)if(c.parentNode)c=c.parentNode;else break;a+=Thread.domToBB(h,MYBB_SMILIES,c,1);a+="\n[/quote]\n";delete h;Thread.updateMessageBox(a)}};
Thread.updateMessageBox=function(a){MyBBEditor.insertText(a,"","","","quote");setTimeout(function(){offset=$("#quickreply_e").offset().top-60;setTimeout(function(){$("html, body").animate({scrollTop:offset},700)},200)},100)};Thread.RGBtoHex=function(a,b,e){return Thread.toHex(a)+Thread.toHex(b)+Thread.toHex(e)};
Thread.toHex=function(a){if(null==a)return"00";a=parseInt(a);if(0==a||isNaN(a))return"00";a=Math.max(0,a);a=Math.min(a,255);a=Math.round(a);return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)};
Thread.textNodeSpanToBB=function(a){var b="",e="",c="",e=window.getComputedStyle(a,null);"underline"==e.getPropertyValue("text-decoration")&&(b="[u]"+b,c+="[/u]");if(400<e.getPropertyValue("font-weight")||"bold"==e.getPropertyValue("font-weight"))b="[b]"+b,c+="[/b]";"italic"==e.getPropertyValue("font-style")&&(b="[i]"+b,c+="[/i]");e=Thread.normaliseColour(e.getPropertyValue("color"));Thread.normaliseColour($(".post_body").css("color"))!=e&&(b="[color\x3d"+e+"]"+b,c+="[/color]");return(e=a.childNodes[0].data.replace(/[\n\t]+/,
""))?b+e+c:""};Thread.normaliseColour=function(a){var b;a=a||"#000";return(b=a.match(/rgb\((\d{1,3}),\s*?(\d{1,3}),\s*?(\d{1,3})\)/i))||(b=a.match(/rgba\((\d{1,3}),\s*?(\d{1,3}),\s*?(\d{1,3}),\s*?(\d*\.?\d+\s*)\)/i))?"#"+Thread.RGBtoHex(b[1],b[2],b[3]):(b=a.match(/#([0-f])([0-f])([0-f])\s*?$/i))?"#"+b[1]+b[1]+b[2]+b[2]+b[3]+b[3]:a};
Thread.domToBB=function(a,b,e,c){for(var h="",d,f,k,g,m=0;m<a.childNodes.length;m++){d=a.childNodes[m];g=k=f="";var n=null,l=null;if("undefined"==typeof d.tagName)switch(d.nodeName){case "#text":1==c&&"undefined"!==typeof e.tagName?(l=document.createElement("span"),n=d.cloneNode(),l.appendChild(n),l.style.display="none",e.appendChild(l),h+=Thread.textNodeSpanToBB(l),l.removeChild(n),e.removeChild(l)):h+=d.data.replace(/[\n\t]+/,"")}else{switch(d.tagName){case "SPAN":switch(!0){case "underline"==d.style.textDecoration:f=
"[u]";g="[/u]";break;case 0<d.style.fontWeight:case "bold"==d.style.fontWeight:f="[b]";g="[/b]";break;case "italic"==d.style.fontStyle:f="[i]";g="[/i]";break;case ""!=d.style.fontFamily:f="[font\x3d"+d.style.fontFamily+"]";g="[/font]";break;case ""!=d.style.fontSize:f="[size\x3d"+d.style.fontSize+"]";g="[/size]";break;case ""!=d.style.color:-1!=d.style.color.indexOf("rgb")?(f=d.style.color.replace("rgb(","").replace(")","").split(","),f="#"+Thread.RGBtoHex(parseInt(f[0]),parseInt(f[1]),parseInt(f[2]))):
f=d.style.color,f="[color\x3d"+f+"]",g="[/color]"}break;case "STRONG":case "B":f="[b]";g="[/b]";break;case "EM":case "I":f="[i]";g="[/i]";break;case "U":f="[u]";g="[/u]";break;case "IMG":b[d.src]?(f="",k=b[d.src],g=""):(f="[img]",k=d.src,g="[/img]");break;case "A":switch(!0){case 0==d.href.indexOf("mailto:"):f="[email\x3d"+d.href.replace("mailto:","")+"]";g="[/email]";break;default:f="[url\x3d"+d.href+"]",g="[/url]"}break;case "OL":f="[list\x3d"+d.type+"]";g="\n[/list]";break;case "UL":f="[list]";
g="\n[/list]";break;case "LI":f="\n[*]";g="";break;case "BLOCKQUOTE":d.removeChild(d.firstChild);f="[quote]\n";g="\n[/quote]";break;case "DIV":d.style.textAlign&&(f="[align\x3d"+d.style.textAlign+"]\n",g="\n[/align]\n");switch(d.className){case "codeblock":f="[code]\n";g="\n[/code]";d.removeChild(d.getElementsByTagName("div")[0]);break;case "codeblock phpcodeblock":k=d.getElementsByTagName("code")[0],d.removeChild(d.getElementsByTagName("div")[0]),f="[php]\n",k=k.innerText?k.innerText:k.innerHTML.replace(/<br([^>]*)>/gi,
"\n").replace(/<([^<]+)>/gi,"").replace(/&nbsp;/gi," "),g="\n[/php]"}break;case "P":g="\n\n";break;case "BR":g="\n"}h+=f+k;""==k&&d.childNodes&&0<d.childNodes.length&&(h+=Thread.domToBB(d,b,e,c+1));h+=g}}return h};